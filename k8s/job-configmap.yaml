apiVersion: v1
kind: ConfigMap
metadata:
  name: algosvc-input-data
data:
  sample.json: |
    {
      "x": [-2, -1, 0, 1, 2],
      "scale": 2.0
    }
  test1.json: |
    {
      "x": [0.5, 1.0, 1.5, 2.0],
      "scale": 1.5
    }
  test2.json: |
    {
      "x": [0, 0.5, 1.0],
      "scale": 1.0
    }
---
apiVersion: batch/v1
kind: Job
metadata:
  name: algosvc-job-configmap
spec:
  completions: 1
  parallelism: 1
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: algosvc
    spec:
      restartPolicy: Never
      securityContext:
        runAsNonRoot: true
        fsGroup: 10001
      initContainers:
        - name: copy-input
          image: busybox
          command: ['sh', '-c']
          args:
            - |
              echo "Copying input files from ConfigMap..."
              cp /configmap/* /input/
              ls -la /input/
          volumeMounts:
            - name: configmap-data
              mountPath: /configmap
            - name: input-data
              mountPath: /input
      containers:
        - name: app
          image: algosvc:v0.1.0
          imagePullPolicy: Never
          env:
            - name: INPUT_DIR
              value: "/rundata/input"
            - name: OUTPUT_DIR
              value: "/rundata/output"
            - name: ALGO_VERSION
              value: "0.1.0"
            - name: LD_LIBRARY_PATH
              value: "/app/lib"
            - name: JAVA_TOOL_OPTIONS
              value: "-XX:+UseContainerSupport -XX:MaxRAMPercentage=75"
          resources:
            requests:
              cpu: "500m"
              memory: "1Gi"
            limits:
              cpu: "1"
              memory: "2Gi"
          volumeMounts:
            - name: input-data
              mountPath: /rundata/input
              readOnly: true
            - name: output-data
              mountPath: /rundata/output
      volumes:
        - name: configmap-data
          configMap:
            name: algosvc-input-data
        - name: input-data
          emptyDir: {}
        - name: output-data
          emptyDir: {}

